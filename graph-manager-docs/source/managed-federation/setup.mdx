---
title: Setting up managed federation
sidebar_title: Setup
---

import ProjectConfigPanel from 'gatsby-theme-apollo-docs/shared/project-config-panel.mdx';

This article describes how to set up managed federation for an existing data graph that uses [Apollo Federation](https://www.apollographql.com/docs/apollo-server/federation/introduction/).

> As with all changes, you should first set up managed federation in a non-production environment, such as staging. To support this, you can use [variants](../schema-registry/#managing-environments-with-variants), which are distinct versions of the same data graph for different environments.

## 1. Register your implementing services

To enable managed federation, each of your data graph's [implementing services](https://www.apollographql.com/docs/apollo-server/federation/implementing-services/) must register its schema with Graph Manager:

```mermaid
graph BT;
  subgraph " "
  gateway([Gateway]);
  serviceA[Products service];
  serviceB[Reviews service];
  serviceC[Inventory service];
  end
  graphManager{{Apollo Graph Manager}};
  gateway --- serviceA & serviceB & serviceC;
  serviceA & serviceB & serviceC -. apollo service:push .-> graphManager;
  class graphManager secondary;
```

To get set up with schema registration, do the following for each of your implementing services:

1. Complete the following prerequisites:

  <ProjectConfigPanel />

2. In the service's `apollo.config.js` file, add `name` and `url` fields to the `service` object:

    ```json{3-4}:title=apollo.config.js
    module.exports = {
      service: {
        name: "Products"
        url: "http://products-graphql.svc.cluster.local:4001/"
        endpoint: {
          url: "http://localhost:4000"
        }
      }
    };
    ```

    * The `name` field uniquely identifies the service within your data graph. Its value appears throughout the Graph Manager UI.
    * The `url` field points to your service's GraphQL endpoint. To secure your data graph, this should be a URL that can be reached by your [gateway](https://www.apollographql.com/docs/apollo-server/federation/gateway/), but _cannot_ be reached via the public internet.

3. From your project's root directory, run the following:

    ```
    apollo service:push --tag=staging
    ```

    The CLI obtains all necessary configuration from your project's `.env` and `apollo.config.js` files, then pushes your schema to Graph Manager under the `staging` variant.

> When you're ready to register your services in your production environment, you can either remove the `--tag` option to push to the default variant (named `current`) or replace `staging` with a new variant (such as `production`).

## 2. Configure continuous delivery

With managed federation, Graph Manager (_not_ your gateway) is responsible for combining your individual schemas into a single federated schema. Consequently, **each service in your data graph must re-register its schema every time the schema changes.** Otherwise, your gateway can't obtain the latest federated schema from Graph Manager.

The best way to accomplish this is to add the `apollo service:push` call to your continuous delivery pipeline. Every time you push a schema change to production, this call should automatically accompany that push.

For more information on best practices for updating your services, see [Pushing configuration updates safely](./advanced-topics/#pushing-configuration-updates-safely).

## 3. Modify the gateway

Because your gateway isn't responsible for creating your federated schema anymore, you need to modify its initialization.

> This section assumes you are using Apollo Server with the `@apollo/gateway` library as your gateway.

### Remove the `serviceList` argument

A bare-bones initialization of an `ApolloGateway` object looks like this:

```js
const gateway = new ApolloGateway({
  serviceList: [
    { name: 'accounts', url: 'http://localhost:4001' },
    // Additional services defined here
  ],
});
```

The `serviceList` argument specifies the name and URL for each of your implementing services. With managed federation, your gateway obtains this information from Graph Manager instead.

**Remove the `serviceList` argument from your `ApolloGateway` constructor entirely.**

### Connect the gateway to Graph Manager

Like your implementing services, your gateway uses an API key to identify itself to Graph Manager. Create an API key from your graph's Settings page in the [Graph Manager UI](https://engine.apollographql.com/).

Provide your API key to the gateway in any of the following ways:

* In your gateway's environment, set the `ENGINE_API_KEY` envrionment variable to the value of your API key.
* In the constructor of `ApolloServer`, provide an `engine` argument with `apiKey` and `schemaTag` fields, like so:

    ```js{9-12}
    const { ApolloServer } = require('apollo-server');
    const { ApolloGateway } = require('@apollo/gateway');

    const gateway = new ApolloGateway();

    // Pass the gateway to Apollo Server
    const server = new ApolloServer({
      gateway,
      engine: {
        apiKey: YOUR_API_KEY,
        schemaTag: 'staging'
      },
      subscriptions: false 
    });

    server.listen().then(({ url }) => {
      console.log(`ðŸš€ Server ready at ${url}`);
    });
    ```

    The `engine` object is of type `EngineReportingOptions`. [See the API reference for all available fields.](https://www.apollographql.com/docs/apollo-server/api/apollo-server/#enginereportingoptions)

As with your services, you can either remove or replace the `schemaTag` argument when you're ready to deploy to your production environment.

> When running your gateway in an environment where outbound traffic to the internet is restricted, consult the [directions for configuring a proxy](https://www.apollographql.com/docs/apollo-server/proxy-configuration/) within Apollo Server.

## 4. Deploy the modified gateway

You can now deploy your modified gateway to begin fetching your federated schema from Graph Manager instead of directly from your services.

On startup, Apollo Server will use the API key you've specified to contact Graph Manager and pull down the federated schema. See Apollo Server's log output for details.
